<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Digibouquet MVP</title>
  <style>
    :root{
  --bg:#faf2f0;        /* blush base */
  --panel:rgba(255,255,255,.70);
  --panel2:rgba(255,255,255,.55);
  --text:#762e00;      /* deep spice brown */
  --muted:rgba(118,46,0,.65);
  --line:rgba(118,46,0,.18);
  --btn:rgba(242,174,28,.10);
  --btn2:rgba(242,174,28,.18);
  --gold:#f2ae1c;
  --olive:#6c714a;
}
body{
  background:var(--bg);
  color:var(--text);
}
.card{
  background:var(--panel);
  border:1px solid var(--line);
  box-shadow:none;
}
.btn{
  background:transparent;
  border:1px solid var(--line);
}
.btn.primary{
  border-color:rgba(242,174,28,.65);
}
.pill{
  background:rgba(220,189,172,.18);
  border:1px solid var(--line);
  color:var(--muted);
}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="h">
      <h1>Kamely Digital Bouquet MVP</h1>
      <span class="pill">Tip: Shuffle → then drag flowers if you want</span>
    </div>
    <div id="builderView">  
        <div class="grid" style="margin-top:14px">
        <!-- LEFT PANEL -->
        <div class="card">
            <h2>1) Choose flowers (max 6 types in this MVP)</h2>
            <div class="picker" id="picker"></div>

            <h2>2) Bouquet controls</h2>
            <div class="row">
            <button class="btn primary" id="shuffleBtn">Shuffle bouquet</button>
            <button class="btn" id="shuffleGreensBtn">Shuffle greens</button>
            <button class="btn" id="resetBtn">Reset</button>
            </div>
            <div class="row" style="margin-top:10px">
            <label class="pill"><input id="manualToggle" type="checkbox" checked style="width:auto;margin:0"> Manual drag enabled</label>
            <span class="pill">Flowers: <span id="flowerCount">0</span></span>
            </div>

            <h2>3) Card + song link</h2>
            <div class="row">
            <input id="toInput" placeholder="To (optional)" />
            <input id="fromInput" placeholder="From (optional)" />
            </div>
            <div style="margin-top:10px">
            <textarea id="msgInput" placeholder="Write a short note… (keep it small for share links)"></textarea>
            </div>
            <div style="margin-top:10px">
            <input id="songInput" placeholder="Paste a Spotify / Apple Music / YouTube link (optional)" />
            </div>

            <h2>4) Share</h2>
            <div class="row">
            <button class="btn primary" id="copyLinkBtn">Copy share link</button>
            <button class="btn" id="openShareBtn">Open share view</button>
            </div>
            <div class="muted" id="shareStatus" style="margin-top:10px"></div>

            <div class="hr"></div>

            <h2>Scent recommendation (your products)</h2>
            <div class="muted">Based on chosen flowers, suggest an essential oil / spice blend people can buy to “smell the bouquet”.</div>
            <div id="scentBox" style="margin-top:10px"></div>

            <h2>Shop links</h2>
            <div class="shopItem">
            <div>
                <div><strong>Your Store</strong></div>
                <div class="tag">Replace with your product page URL</div>
            </div>
            <a class="btn" id="shopLink" href="#" target="_blank" rel="noopener">Set URL</a>
            </div>
        </div>

        <!-- RIGHT PANEL -->
        <div class="card">
            <div class="h">
            <h2 style="margin:0">Bouquet builder</h2>
            <span class="pill">Drag flowers in stage</span>
            </div>

            <div class="bouquetStage" id="stage">
            <div class="stageHint">
                <span class="pill">Shuffle first for a nice layout</span>
                <span class="pill">Then drag + reposition</span>
            </div>
            <div class="layerTag">greens behind • flowers front</div>
            </div>

            <div class="previewShell">
            <div class="sharePage">
                <h2 style="margin:0 0 8px">Preview (what the share page shows)</h2>
                <div class="bouquetStage" id="previewStage" style="height:340px"></div>
            </div>
            <div class="letter">
                <div class="to" id="previewTo"></div>
                <div class="msg" id="previewMsg"></div>
                <div class="muted" id="previewFrom" style="margin-top:8px"></div>
                <div class="song" id="previewSongWrap" style="display:none">
                <a class="btn play" id="previewSongBtn" href="#" target="_blank" rel="noopener">Play the song</a>
                </div>
                <div class="hr"></div>
                <div class="muted">Scent suggestion:</div>
                <div id="previewScent" style="margin-top:8px"></div>
            </div>
            </div>

            <div class="muted" style="margin-top:10px">
            Share links store everything in the URL (no accounts). Keep the note reasonably short.
            </div>
            </div>
        </div>
        </div>
    </div>
    <div id="shareView" style="display:none">
        <div class="wrap">
  <div class="card" style="max-width:820px;margin:18px auto;padding:18px">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
      <div>
        <div style="letter-spacing:.18em;text-transform:uppercase;font-weight:800;font-size:12px;color:var(--muted)">
          Digibouquet
        </div>
        <div style="margin-top:6px;font-size:14px;color:var(--muted)">
          A love letter from the island
        </div>
      </div>
      <div style="font-size:12px;color:var(--muted)" id="shareTypedOn"></div>
    </div>

    <div style="margin-top:18px">
      <div class="bouquetStage" id="shareStage" style="height:360px;background:transparent;border:1px solid var(--line)"></div>
    </div>

    <div style="height:1px;background:rgba(242,174,28,.45);margin:18px 0"></div>

    <div class="letter" style="background:transparent;border:none;padding:0">
      <div class="to" id="shareTo" style="color:var(--muted)"></div>
      <div class="msg" id="shareMsg" style="margin-top:10px"></div>
      <div class="muted" id="shareFrom" style="margin-top:10px"></div>

      <div class="song" id="shareSongWrap" style="margin-top:14px;display:none">
        <a class="btn primary" id="shareSongBtn" href="#" target="_blank" rel="noopener">Play the song</a>
      </div>
    </div>

    <div style="height:1px;background:rgba(118,46,0,.12);margin:18px 0"></div>

    <div>
      <div style="letter-spacing:.18em;text-transform:uppercase;font-weight:800;font-size:12px;color:var(--muted)">
        Island Scent Formula
      </div>
      <div id="shareFormula" style="margin-top:10px"></div>

      <div style="margin-top:12px;color:var(--muted);font-size:13px">
        Complete the ritual with Madagascar Honey →
        <a href="https://www.kamelyofficiel.com/honey" target="_blank" rel="noopener">Discover</a>
      </div>
    </div>

    <div style="margin-top:18px;color:var(--muted);font-size:12px">
      Recipes are for diffuser use. For topical use, dilute properly and patch test.
    </div>
  </div>
</div>

  <div class="btnRow" style="justify-content:center;margin:0 auto 28px;max-width:820px;gap:10px;flex-wrap:wrap">
    <button class="btn" id="shareBackBtn" type="button">Back</button>
    <button class="btn" id="shareCopyBtn" type="button">Copy link</button>
    <button class="btn" id="shareNativeBtn" type="button">Share</button>
    <button class="btn primary" id="shareConfirmBtn" type="button">Confirm</button>
    <button class="btn" id="shareDownloadBtn" type="button" disabled>Download image</button>
  </div>
    </div>

<script>
/** =========================
 *  FLOWERS + GREEN ASSETS
 *  Replace SVGs with your own PNGs later (same IDs).
 *  ========================= */
const FLOWERS = [
  { id:"rose",  name:"Rose Bloom",  icon: flowerSVG("#ff4d6d","#b5179e"), scent: { blend:"Romantic Rose + Vanilla", notes:["rose absolute (or geranium)", "vanilla", "sweet orange"] } },
  { id:"lily",  name:"Island Blossom",  icon: flowerSVG("#e9ecef","#adb5bd"), scent: { blend:"Clean White Floral", notes:["lavender", "bergamot", "cedarwood"] } },
  { id:"tulip", name:"Spice Petal", icon: flowerSVG("#ffb703","#fb8500"), scent: { blend:"Sunny Citrus Bloom", notes:["sweet orange", "grapefruit", "ylang ylang"] } },
 // { id:"peony", name:"Peony", icon: flowerSVG("#ffd6ff","#c77dff"), scent: { blend:"Soft Powdery Floral", notes:["palmarosa", "lavender", "orris-style (optional)"] } },
  { id:"daisy", name:"Eucalyptus Whisper", icon: flowerSVG("#f8f9fa","#ffd60a"), scent: { blend:"Fresh Meadow", notes:["lemongrass", "rosemary", "peppermint (light)"] } },
  { id:"orchid",name:"Ylang Star",icon: flowerSVG("#bde0fe","#4361ee"), scent: { blend:"Exotic Spa Floral", notes:["ylang ylang", "lime", "sandalwood"] } },
];

const GREENS = [
  { id:"fern",   icon: greenSVG("#2dd4bf","#0ea5e9") },
  { id:"euca",   icon: greenSVG("#34d399","#22c55e") },
  { id:"ivy",    icon: greenSVG("#a7f3d0","#16a34a") },
];

const OIL_LINKS = {
  cinnamon: "https://www.kamelyofficiel.com/essential-oil-1/cinnamon",
  citriodora: "https://www.kamelyofficiel.com/essential-oil-1/citriodora",
  clove: "https://www.kamelyofficiel.com/essential-oil-1/cloveclaws",
  geranium: "https://www.kamelyofficiel.com/essential-oil-1/geranium",
  ginger: "https://www.kamelyofficiel.com/essential-oil-1/ginger",
  helychrise: "https://www.kamelyofficiel.com/essential-oil-1/helychrise",
  niaouli: "https://www.kamelyofficiel.com/essential-oil-1/niaouli",
  ravintsara: "https://www.kamelyofficiel.com/essential-oil-1/ravintsara",
  ylang: "https://www.kamelyofficiel.com/essential-oil-1/ylangylang1",
};

/** =========================
 *  STATE
 *  ========================= */
const defaultState = () => ({
  flowers: [], // {typeId, x, y, s, r, z}
  greens:  [], // {typeId, x, y, s, r, z}
  counts:  Object.fromEntries(FLOWERS.map(f => [f.id, 0])),
  card: { to:"", from:"", msg:"" },
  songUrl: "",
  shopUrl: ""
});

let state = defaultState();

/** =========================
 *  DOM
 *  ========================= */
const pickerEl = document.getElementById("picker");
const stageEl = document.getElementById("stage");
const previewStageEl = document.getElementById("previewStage");
const flowerCountEl = document.getElementById("flowerCount");
const manualToggleEl = document.getElementById("manualToggle");
const toInput = document.getElementById("toInput");
const fromInput = document.getElementById("fromInput");
const msgInput = document.getElementById("msgInput");
const songInput = document.getElementById("songInput");
const shareStatus = document.getElementById("shareStatus");
const scentBox = document.getElementById("scentBox");
const previewTo = document.getElementById("previewTo");
const previewFrom = document.getElementById("previewFrom");
const previewMsg = document.getElementById("previewMsg");
const previewSongWrap = document.getElementById("previewSongWrap");
const previewSongBtn = document.getElementById("previewSongBtn");
const previewScent = document.getElementById("previewScent");
const shopLink = document.getElementById("shopLink");
const builderView = document.getElementById("builderView");
const shareView = document.getElementById("shareView");
const shareStage = document.getElementById("shareStage");
const shareTypedOn = document.getElementById("shareTypedOn");
const shareTo = document.getElementById("shareTo");
const shareFrom = document.getElementById("shareFrom");
const shareMsg = document.getElementById("shareMsg");
const shareSongWrap = document.getElementById("shareSongWrap");
const shareSongBtn = document.getElementById("shareSongBtn");
const shareFormula = document.getElementById("shareFormula");

/** =========================
 *  INIT
 *  ========================= */
renderPicker();
wireInputs();
loadFromUrlOrInit();
renderAll();

/** =========================
 *  PICKER UI
 *  ========================= */
function renderPicker(){
  pickerEl.innerHTML = "";
  FLOWERS.forEach(f => {
    const el = document.createElement("div");
    el.className = "pick";
    el.innerHTML = `
      <div class="mini">${f.icon}</div>
      <div>
        <strong>${f.name}</strong>
        <small class="muted">${f.scent.blend}</small>
      </div>
      <div class="count">
        <button class="btn" data-act="dec" data-id="${f.id}">-</button>
        <span class="pill" id="count_${f.id}">0</span>
        <button class="btn" data-act="inc" data-id="${f.id}">+</button>
      </div>
    `;
    pickerEl.appendChild(el);
  });

  pickerEl.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-act]");
    if(!btn) return;
    const id = btn.getAttribute("data-id");
    const act = btn.getAttribute("data-act");
    if(act === "inc") addFlower(id);
    if(act === "dec") removeFlower(id);
    renderAll();
  }, { once:false });
}

function addFlower(typeId){
  state.counts[typeId] = (state.counts[typeId] || 0) + 1;
  if(state.flowers.length >= 7) return;
  // add a new flower item (position filled by shuffle)
  state.flowers.push({
    typeId,
    x: 160, y: 240,
    s: 1,
    r: rand(-18,18),
    z: state.flowers.length + 10
  });
}

function removeFlower(typeId){
  if((state.counts[typeId] || 0) <= 0) return;
  state.counts[typeId] -= 1;
  // remove the most recent one of that type
  const idx = [...state.flowers].reverse().findIndex(it => it.typeId === typeId);
  if(idx !== -1){
    const real = state.flowers.length - 1 - idx;
    state.flowers.splice(real, 1);
  }
}

/** =========================
 *  CONTROLS
 *  ========================= */
document.getElementById("shuffleBtn").onclick = () => { autoArrangeFlowers(); renderAll(); };
document.getElementById("shuffleGreensBtn").onclick = () => { autoArrangeGreens(); renderAll(); };
document.getElementById("resetBtn").onclick = () => { state = defaultState(); renderAll(); pushStateToUrl(false); shareStatus.textContent="Reset."; };

document.getElementById("copyLinkBtn").onclick = async () => {
  const url = buildShareUrl();
  try{
    await navigator.clipboard.writeText(url);
    shareStatus.innerHTML = `<span class="ok">Copied.</span> Paste to share.`;
  }catch{
    shareStatus.textContent = "Could not copy automatically. Select and copy from address bar after Open share view.";
  }
};

document.getElementById("openShareBtn").onclick = () => {
  const url = buildShareUrl();
  window.open(url, "_blank");
};

shopLink.onclick = (e) => {
  if(state.shopUrl) return;
  e.preventDefault();
  const u = prompt("Paste your store URL (e.g. your Shopify product page):");
  if(!u) return;
  state.shopUrl = u.trim();
  renderAll();
  pushStateToUrl(false);
};

function wireInputs(){
  const sync = () => {
    state.card.to = toInput.value;
    state.card.from = fromInput.value;
    state.card.msg = msgInput.value;
    state.songUrl = songInput.value.trim();
    renderAllPreviewOnly();
    pushStateToUrl(false);
  };
  [toInput, fromInput, msgInput, songInput].forEach(el => {
    el.addEventListener("input", debounce(sync, 120));
  });
}

/** =========================
 *  ARRANGEMENT
 *  ========================= */
function autoArrangeGreens(){
  // 5-8 greens behind
  const count = randInt(2, 3);
  state.greens = [];
  for(let i=0;i<count;i++){
    const g = GREENS[randInt(0, GREENS.length-1)];
    const t = i / Math.max(1, count-1);
    const x = 80 + t*280 + rand(-40,40);
    const y = 210 + rand(-60,80);
    state.greens.push({
      typeId: g.id,
      x, y,
      s: rand(0.9, 1.35),
      r: rand(-25,25),
      z: i
    });
  }
}

function autoArrangeFlowers(){
  if(state.greens.length === 0) autoArrangeGreens();
  const W = stageEl.clientWidth;
  const H = stageEl.clientHeight;

  // Bouquet region: a soft "cone/oval" centered.
  const cx = W * 0.52;
  const cy = H * 0.55;

  // Place flowers with controlled randomness
  state.flowers.forEach((fl, i) => {
    const t = i / Math.max(1, state.flowers.length-1);
    const spreadX = lerp(160, 80, t);   // narrower as we go down
    const spreadY = lerp(110, 70, t);

    const x = cx + rand(-spreadX, spreadX);
    const y = cy + rand(-spreadY, spreadY) - t*30;

    fl.x = clamp(x, 20, W-60);
    fl.y = clamp(y, 20, H-60);
    fl.s = rand(0.85, 1.25);
    fl.r = rand(-18, 18);
    fl.z = 100 + i; // keep flowers above greens
  });

  // Shuffle z slightly so overlap feels natural
  state.flowers.sort(() => Math.random() - 0.5);
  state.flowers.forEach((f,i)=> f.z = 100+i);
}

/** =========================
 *  RENDERING
 *  ========================= */
function renderAll(){
  // counts in UI
  FLOWERS.forEach(f => {
    const c = state.counts[f.id] || 0;
    const el = document.getElementById(`count_${f.id}`);
    if(el) el.textContent = c;
  });

  flowerCountEl.textContent = state.flowers.length;

  // inputs
  toInput.value = state.card.to;
  fromInput.value = state.card.from;
  msgInput.value = state.card.msg;
  songInput.value = state.songUrl || "";

  // shop link
  shopLink.textContent = state.shopUrl ? "Open" : "Set URL";
  shopLink.href = state.shopUrl ? state.shopUrl : "#";

  // stage render
  renderStage(stageEl, true);
  renderStage(previewStageEl, false);

  // scent boxes
  renderScent();
  renderAllPreviewOnly();

  // keep URL reasonably current
  pushStateToUrl(false);
}

function renderAllPreviewOnly(){
  previewTo.textContent = state.card.to ? `To: ${state.card.to}` : "";
  previewFrom.textContent = state.card.from ? `— ${state.card.from}` : "";
  previewMsg.textContent = state.card.msg || "(your note shows here)";

  if(state.songUrl){
    previewSongWrap.style.display = "";
    previewSongBtn.href = state.songUrl;
    previewSongBtn.textContent = `Play the song`;
  } else {
    previewSongWrap.style.display = "none";
  }

  // preview scent
  const s = computeScentRecommendation();
  previewScent.innerHTML = s.html;
}

function renderStage(stage, enableDrag){
  stage.innerHTML = stage === stageEl
    ? `<div class="stageHint">
         <span class="pill">Shuffle first for a nice layout</span>
         <span class="pill">Then drag + reposition</span>
       </div>
       <div class="layerTag">greens behind • flowers front</div>`
    : "";

  // render greens
  state.greens
    .slice()
    .sort((a,b)=>a.z-b.z)
    .forEach(item => {
      const g = GREENS.find(x => x.id === item.typeId);
      if(!g) return;
      stage.appendChild(makeSprite(item, g.icon, "greens", enableDrag && stage===stageEl));
    });

  // render flowers
  state.flowers
    .slice()
    .sort((a,b)=>a.z-b.z)
    .forEach(item => {
      const f = FLOWERS.find(x => x.id === item.typeId);
      if(!f) return;
      stage.appendChild(makeSprite(item, f.icon, "flowers", enableDrag && stage===stageEl));
    });
}

function makeSprite(item, svg, layer, draggable){
  const el = document.createElement("div");
  el.className = "draggable";
  el.style.left = item.x + "px";
  el.style.top  = item.y + "px";
  el.style.zIndex = item.z;
  el.style.transform = `translate(-50%,-50%) rotate(${item.r}deg) scale(${item.s})`;
  el.innerHTML = `<div class="icon" style="width:56px;height:56px">${svg}</div>`;

  if(draggable && manualToggleEl.checked && layer === "flowers"){
    attachDrag(el, item);
  }
  return el;
}

function attachDrag(el, item){
  let startX=0, startY=0, baseX=0, baseY=0, dragging=false;

  el.addEventListener("pointerdown", (e) => {
    if(!manualToggleEl.checked) return;
    dragging = true;
    el.setPointerCapture(e.pointerId);
    startX = e.clientX; startY = e.clientY;
    baseX = item.x; baseY = item.y;
    // bring forward
    const maxZ = Math.max( ...state.flowers.map(f=>f.z), 100 );
    item.z = maxZ + 1;
    renderAll(); // re-render to apply z; simple for MVP
  });

  el.addEventListener("pointermove", (e) => {
    if(!dragging) return;
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    item.x = baseX + dx;
    item.y = baseY + dy;
    // update visually without full rerender
    el.style.left = item.x + "px";
    el.style.top  = item.y + "px";
    renderStage(previewStageEl, false);
  });

  el.addEventListener("pointerup", () => {
    dragging = false;
    pushStateToUrl(false);
  });
}

/** =========================
 *  SCENT RECOMMENDATIONS
 *  ========================= */
function computeScentRecommendation(){
  const counts = state.counts || {};

  const romanticScore =
    (counts["rose"]||0) + (counts["ylang"]||0) + (counts["orchid"]||0);

  const freshScore =
    (counts["eucalyptus"]||0) + (counts["lily"]||0) + (counts["daisy"]||0);

  const spiceScore =
    (counts["spice"]||0);

  let key = "romance";
  if(spiceScore > 0) key = "warm";
  else if(freshScore > romanticScore) key = "fresh";

  const formulas = {
    romance: {
      title: "Island Romance",
      mood: "Soft, enveloping, intimate.",
      oils: [
        { k:"geranium", label:"Geranium", parts:3 },
        { k:"ylang", label:"Ylang-Ylang", parts:2 },
        { k:"ravintsara", label:"Ravintsara", parts:2 },
      ]
    },
    fresh: {
      title: "Fresh Devotion",
      mood: "Clean, luminous, tender.",
      oils: [
        { k:"citriodora", label:"Citriodora", parts:3 },
        { k:"helychrise", label:"Helychrise", parts:2 },
        { k:"ravintsara", label:"Ravintsara", parts:2 },
      ]
    },
    warm: {
      title: "Warm Affection",
      mood: "Passionate, comforting, deep.",
      oils: [
        { k:"cinnamon", label:"Cinnamon", parts:2 },
        { k:"clove", label:"Clove", parts:2 },
        { k:"ginger", label:"Ginger", parts:2 },
        { k:"geranium", label:"Geranium", parts:1 },
      ]
    }
  };

  const f = formulas[key];

  const oilLinksInline = f.oils.map(o => {
    const url = OIL_LINKS[o.k] || "#";
    return `<a href="${url}" target="_blank" rel="noopener" class="pill" style="text-decoration:none">${o.label}</a>`;
  }).join(" ");

  const partsLine = f.oils.map(o => `${o.parts} part${o.parts>1?"s":""} ${o.label}`).join(" · ");

  const html = `
    <div style="margin-top:8px">
      <div style="font-weight:900;letter-spacing:.18em;text-transform:uppercase;font-size:12px;color:var(--muted)">${f.title}</div>
      <div style="margin-top:8px;color:var(--muted)">${f.mood}</div>
      <div style="margin-top:10px">${oilLinksInline}</div>
      <div style="margin-top:10px;color:var(--muted);font-size:13px">${partsLine}</div>
    </div>
  `;

  return { html, key };
}

function renderScent(){
  const rec = computeScentRecommendation();
  scentBox.innerHTML = rec.html;
}

/** =========================
 *  SHARE LINK (URL HASH)
 *  ========================= */
function buildShareUrl(){
  const payload = minimalPayload();
  const encoded = encodePayload(payload);
  const base = location.origin + location.pathname; // same file
  return `${base}#b=${encoded}`;
}

function minimalPayload(){
  // keep payload small
  return {
    f: state.flowers.map(x => [x.typeId, round(x.x), round(x.y), round2(x.s), round2(x.r), x.z]),
    g: state.greens.map(x => [x.typeId, round(x.x), round(x.y), round2(x.s), round2(x.r), x.z]),
    c: state.counts,
    card: { t: state.card.to, f: state.card.from, m: state.card.msg },
    song: state.songUrl,
    shop: state.shopUrl
  };
}

function encodePayload(obj){
  const json = JSON.stringify(obj);
  // base64url
  const b64 = btoa(unescape(encodeURIComponent(json)))
    .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  return b64;
}

function decodePayload(b64url){
  const b64 = b64url.replace(/-/g,'+').replace(/_/g,'/');
  const pad = b64.length % 4 ? '='.repeat(4 - (b64.length % 4)) : '';
  const json = decodeURIComponent(escape(atob(b64 + pad)));
  return JSON.parse(json);
}

function pushStateToUrl(replace=true){
  // keep hash in sync, but do not spam history
  const encoded = encodePayload(minimalPayload());
  const newHash = `#b=${encoded}`;
  if(replace) history.replaceState(null, "", newHash);
  else history.replaceState(null, "", newHash);
}

function loadFromUrlOrInit(){
  const hash = location.hash || "";
  const match = hash.match(/#b=([A-Za-z0-9\-_]+)/);
  if(!match){
    // init with greens so it looks nice
    autoArrangeGreens();
    setViewMode(false); // show builder normally
    return;
  }
  try{
    const payload = decodePayload(match[1]);
    // hydrate
    state = defaultState();
    state.flowers = (payload.f||[]).map(a => ({ typeId:a[0], x:a[1], y:a[2], s:a[3], r:a[4], z:a[5] }));
    state.greens  = (payload.g||[]).map(a => ({ typeId:a[0], x:a[1], y:a[2], s:a[3], r:a[4], z:a[5] }));
    state.counts  = payload.c || state.counts;
    state.card = {
      to: (payload.card?.t)||"",
      from:(payload.card?.f)||"",
      msg: (payload.card?.m)||""
    };
    state.songUrl = payload.song || "";
    state.shopUrl = payload.shop || "";
    // If positions are missing, arrange
    if(state.greens.length===0) autoArrangeGreens();
    if(state.flowers.length>0) {
      // keep existing positions; but ensure z sane
      state.flowers.forEach((f,i)=> f.z = f.z ?? (100+i));
    }
    setViewMode(true);
  }catch(err){
    shareStatus.textContent = "Could not load shared bouquet (bad link).";
    autoArrangeGreens();
  }
}

/** =========================
 *  SMALL HELPERS
 *  ========================= */
function flowerSVG(petal, center){
  return `
  <svg viewBox="0 0 64 64" width="26" height="26" aria-hidden="true">
    <g>
      <circle cx="32" cy="18" r="10" fill="${petal}" opacity="0.95"/>
      <circle cx="18" cy="30" r="10" fill="${petal}" opacity="0.9"/>
      <circle cx="46" cy="30" r="10" fill="${petal}" opacity="0.9"/>
      <circle cx="24" cy="46" r="10" fill="${petal}" opacity="0.9"/>
      <circle cx="40" cy="46" r="10" fill="${petal}" opacity="0.9"/>
      <circle cx="32" cy="34" r="9" fill="${center}" opacity="0.95"/>
      <circle cx="32" cy="34" r="4" fill="rgba(255,255,255,.55)"/>
    </g>
  </svg>`;
}

function greenSVG(a,b){
  return `
  <svg viewBox="0 0 64 64" width="26" height="26" aria-hidden="true">
    <path d="M14 44c10-22 22-28 36-30-6 12-10 26-8 40-10-2-18-6-28-10z" fill="${a}" opacity=".9"/>
    <path d="M20 50c6-16 18-24 30-26-4 10-6 20-4 32-8-2-16-4-26-6z" fill="${b}" opacity=".55"/>
  </svg>`;
}

function rand(min,max){ return Math.random()*(max-min)+min; }
function randInt(min,max){ return Math.floor(rand(min, max+1)); }
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function lerp(a,b,t){ return a + (b-a)*t; }
function round(n){ return Math.round(n); }
function round2(n){ return Math.round(n*100)/100; }

function debounce(fn, ms){
  let t=null;
  return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}

function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}
</script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js">
/* =========================
   Share View (Step 4) — FIXED
   - Works when opening a shared link (#b=...)
   - No blank page (showShareView was missing)
========================= */
const shareView = document.getElementById("shareView");
const shareTypedOn = document.getElementById("shareTypedOn");
const shareToEl = document.getElementById("shareTo");
const shareMsgEl = document.getElementById("shareMsg");
const shareFromEl = document.getElementById("shareFrom");
const shareSongWrap = document.getElementById("shareSongWrap");
const shareSongBtn = document.getElementById("shareSongBtn");
const shareFormulaEl = document.getElementById("shareFormula");
const shareStageEl = document.getElementById("shareStage");

const shareBackBtn = document.getElementById("shareBackBtn");
const shareCopyBtn = document.getElementById("shareCopyBtn");
const shareNativeBtn = document.getElementById("shareNativeBtn");
const shareConfirmBtn = document.getElementById("shareConfirmBtn");
const shareDownloadBtn = document.getElementById("shareDownloadBtn");

function showShareView(){
  if(!builderView || !shareView) return;
  builderView.style.display = "none";
  shareView.style.display = "";
  document.title = "A bouquet for you";

  // Make sure we have a valid layout for the share stage dimensions
  if(!state.layout || !state.layout.length){
    // Ensure stage has measured size; use builder stage as fallback
    ensureLayout(true);
  }

  // Render bouquet into share stage
  // (renderStage() already exists and can target any stage element)
  try{
    renderStage(shareStageEl, false);
  }catch(e){
    // Fallback: if renderStage signature differs, do minimal render via rebuildLayoutForShare
    console.warn("renderStage failed in share view", e);
  }

  // Typed meta
  const d = new Date();
  if(shareTypedOn) shareTypedOn.textContent = `Typed on ${d.toLocaleDateString()}`;

  // Card
  const to = (state.card?.to || "").trim();
  const msg = (state.card?.msg || "").trim();
  const from = (state.card?.from || "").trim();

  if(shareToEl) shareToEl.textContent = to ? `Dear ${to}` : "";
  if(shareMsgEl) shareMsgEl.textContent = msg || "";
  if(shareFromEl) shareFromEl.textContent = from ? `Sincerely, ${from}` : "";

  // Song
  const song = (state.songUrl || "").trim();
  if(song && shareSongWrap && shareSongBtn){
    shareSongWrap.style.display = "";
    shareSongBtn.href = song;
  }else if(shareSongWrap){
    shareSongWrap.style.display = "none";
  }

  // Formula
  try{
    const f = computeFormula();
    const pills = (f.oils || []).map(o => {
      const href = (OIL_LINKS && OIL_LINKS[o.k]) ? OIL_LINKS[o.k] : "#";
      return `<a class="pill" href="${href}" target="_blank" rel="noopener">${escapeHtml(o.label)}</a>`;
    }).join("");
    const partsLine = (f.oils || []).map(o => `${o.parts} part${o.parts>1?"s":""} ${o.label}`).join(" · ");
    if(shareFormulaEl){
      shareFormulaEl.innerHTML = `
        <div class="pillRow" style="justify-content:flex-start">${pills}</div>
        <div class="finePrint" style="margin-top:10px">${escapeHtml(partsLine)}</div>
      `;
    }
  }catch(e){
    console.warn("Formula render failed", e);
  }

  // Reset confirm/download on each entry
  if(shareDownloadBtn) shareDownloadBtn.disabled = true;
}

function hideShareView(){
  if(!builderView || !shareView) return;
  shareView.style.display = "none";
  builderView.style.display = "";
  document.title = "Kamely Digibouquet";
  // Keep the user at the card step (step 3)
  step1.style.display = "none";
  step2.style.display = "none";
  step3.style.display = "";
}

/* When opening a share link directly */
(function ensureShareOnLoad(){
  const match = (location.hash || "").match(/#b=([A-Za-z0-9\-_]+)/);
  if(match){
    try{
      const payload = decodePayload(match[1]);
      // hydrate state from payload
      state = defaultState();
      state.picked = Array.isArray(payload.p) ? payload.p.slice(0,5) : [];
      state.greenIndex = Number.isFinite(payload.gi) ? payload.gi : 0;
      state.layout = (payload.lay||[]).map(a => ({ id:a[0], x:a[1], y:a[2], s:a[3], r:a[4], z:a[5] }));
      state.card = { to: payload.card?.t || "", from: payload.card?.f || "", msg: payload.card?.m || "" };
      state.songUrl = payload.song || "";
    }catch(e){
      // If decode fails, fall back to builder
      console.warn("Bad share payload", e);
      return;
    }
    // Make sure initial render doesn't happen while hidden
    requestAnimationFrame(() => {
      showShareView();
    });
  }
})();

/* Override: Open Share should show Step 4 in the SAME tab (no blank new-tab) */
if(openShareBtn){
  openShareBtn.addEventListener("click", () => {
    const url = buildShareUrl();
    // stay on the same page; just set hash and render share view
    location.hash = url.split("#")[1] || location.hash;
    showShareView();
  });
}

/* Back */
if(shareBackBtn){
  shareBackBtn.addEventListener("click", () => {
    // keep the current builder state, just hide share mode
    history.replaceState(null, "", location.pathname + location.search);
    hideShareView();
  });
}

/* Copy link */
if(shareCopyBtn){
  shareCopyBtn.addEventListener("click", async () => {
    const url = buildShareUrl();
    const ok = await safeCopy(url);
    if(statusEl) statusEl.textContent = ok ? "Link copied." : "Couldn't copy. Select and copy from the address bar.";
  });
}

/* Native share */
if(shareNativeBtn){
  shareNativeBtn.addEventListener("click", async () => {
    const url = buildShareUrl();
    try{
      if(navigator.share){
        await navigator.share({ title: "A bouquet for you", text: "I made you a digital bouquet.", url });
      }else{
        const ok = await safeCopy(url);
        if(statusEl) statusEl.textContent = ok ? "Link copied (sharing not supported on this browser)." : "Sharing not supported; copy from the address bar.";
      }
    }catch(e){
      // user cancelled or browser blocked
    }
  });
}

/* Confirm -> enable download */
if(shareConfirmBtn){
  shareConfirmBtn.addEventListener("click", () => {
    if(shareDownloadBtn) shareDownloadBtn.disabled = false;
    if(statusEl) statusEl.textContent = "Confirmed. You can download now.";
  });
}

/* Download share card as image */
if(shareDownloadBtn){
  shareDownloadBtn.addEventListener("click", async () => {
    try{
      if(shareDownloadBtn.disabled) return;
      if(statusEl) statusEl.textContent = "Preparing download…";

      // Ensure everything is rendered
      showShareView();
      await new Promise(r => requestAnimationFrame(r));

      const card = shareView.querySelector(".card");
      const canvas = await html2canvas(card, { backgroundColor: null, scale: 2, useCORS: true });
      const a = document.createElement("a");
      a.download = "kamely-digibouquet.png";
      a.href = canvas.toDataURL("image/png");
      a.click();

      if(statusEl) statusEl.textContent = "Downloaded.";
    }catch(e){
      console.error(e);
      if(statusEl) statusEl.textContent = "Could not download. Try Chrome (works best with html2canvas).";
    }
  });
}

</script>
</body>
</html>
